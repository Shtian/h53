# Implementation Plan: Global Cabin Header

**Branch**: `001-header` | **Date**: 2025-09-27 | **Spec**: [specs/001-header/spec.md](specs/001-header/spec.md)
**Input**: Feature specification from `/specs/001-header/spec.md`

## Execution Flow (/plan command scope)

```
1. Load feature spec from Input path
   → If not found: ERROR "No feature spec at {path}"
2. Fill Technical Context (scan for NEEDS CLARIFICATION)
   → Detect Project Type from file system structure or context (web=frontend+backend, mobile=app+api)
   → Set Structure Decision based on project type
3. Fill the Constitution Check section based on the content of the constitution document.
4. Evaluate Constitution Check section below
   → If violations exist: Document in Complexity Tracking
   → If no justification possible: ERROR "Simplify approach first"
   → Update Progress Tracking: Initial Constitution Check
5. Execute Phase 0 → research.md
   → If NEEDS CLARIFICATION remain: ERROR "Resolve unknowns"
6. Execute Phase 1 → contracts, data-model.md, quickstart.md, agent-specific template file (e.g., `CLAUDE.md` for Claude Code, `.github/copilot-instructions.md` for GitHub Copilot, `GEMINI.md` for Gemini CLI, `QWEN.md` for Qwen Code or `AGENTS.md` for opencode).
7. Re-evaluate Constitution Check section
   → If new violations: Refactor design, return to Phase 1
   → Update Progress Tracking: Post-Design Constitution Check
8. Plan Phase 2 → Describe task generation approach (DO NOT create tasks.md)
9. STOP - Ready for /tasks command
```

**IMPORTANT**: The /plan command STOPS at step 7. Phases 2-4 are executed by other commands:

- Phase 2: /tasks command creates tasks.md
- Phase 3-4: Implementation execution (manual or via tools)

## Summary

- Deliver a sticky, authenticated global header that surfaces the H53 logo, articles and guestbook navigation, Clerk account controls, and a 1-hour cached yr.no weather snapshot on every member view.
- Replace the current layout header with a split server/client composition so weather data is fetched in a cached server component while menu interactivity runs client-side.
- Ensure the mobile burger menu uses a shadcn drawer that fills the viewport beneath the header with focus trapping while retaining observability hooks for weather fetch failures or menu state errors.

## Technical Context

**Language/Version**: TypeScript 5.5 (strict) with Next.js 15.5 App Router  
**Primary Dependencies**: Next.js 15.5, React 19, TailwindCSS 4.1, @clerk/nextjs, Convex 1.27, Zod 4.1, yr.no HTTP API helper  
**Storage**: Convex (existing collections only); no new persistence layers introduced  
**Testing / Verification**: Manual quickstart walkthroughs (optional Vitest/Playwright coverage when helpful)  
**Target Platform**: Web (Next.js deployment on Vercel/Node >=20)  
**Project Type**: Web application (single Next.js frontend backed by Convex)  
**Performance Goals**: Header render must remain <50 ms on client hydration; weather fetch revalidated at 3600 s to avoid per-request latency; menu toggle responses within 16 ms frame budget  
**Constraints**: Clerk-authenticated surfaces only, Tailwind utility-first styling, no additional CSS frameworks, observability via `src/lib/logging.ts`, reuse existing weather helper with Next.js caching  
**Scale/Scope**: Single global header shared across all authenticated routes; concurrent usage limited to dozens of members per day

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

- **Auth Guarding**: PASS – Header stays inside `SignedIn`/`Authenticated` wrappers in `src/app/layout.tsx`; no public exposure is introduced.
- **Convex-First Data Flow**: PASS – No new persistence; existing Convex data remains canonical and weather snapshot uses Next.js request caching without creating side stores.
- **Tailwind-Only Styling**: PASS – Styling will remain Tailwind utility classes (no global CSS beyond token additions which are not needed).
- **Typed Contracts**: PASS – No new external payloads; weather helper already typed, and any client state will use TypeScript definitions.
- **Test & Observability Discipline**: PASS – logs via `logEvent` on weather/menu error paths.

## Project Structure

### Documentation (this feature)

```
specs/001-header/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
└── tasks.md              # generated by /tasks
```

### Source Code (repository root)

```
src/
├── app/
│   ├── layout.tsx
│   ├── page.tsx
│   ├── articles/
│   └── guestbook/
├── components/
│   ├── layout/Header.tsx
│   └── guestbook/
├── lib/
│   ├── weather/fetchYrNo.ts
│   ├── logging.ts
│   └── validation/
convex/
├── schema.ts
├── messages.ts
├── guestbook.ts
└── articles.ts
public/
└── assets/
```

**Structure Decision**: Single Next.js app with Convex backend; header lives in `src/components/layout/Header.tsx` and will gain a server wrapper plus client overlay module.

## Phase 0: Outline & Research

1. Confirmed sticky header strategy: keep layout as a server component that imports a server `HeaderData` wrapper to fetch cached weather (`revalidate: 3600`) and hand props to a client `HeaderShell`.
2. Documented accessible mobile overlay behaviour using semantic `<dialog>`/`aria-modal` patterns with manual focus trapping (no new dependencies) and ESC/overlay close support.
3. Validated logging/observability approach: instrument weather fetch failures (catch + `logEvent`) and menu state errors; ensure fallback text "Weather unavailable" remains in UI for offline scenarios.

**Output**: `research.md`

## Phase 1: Design & Contracts

1. Captured UI state model (weather snapshot fields + client menu state) in `data-model.md`; no new Convex entities required.
2. No new HTTP/Convex contracts generated; documented rationale in `contracts/README.md`.
3. Authenticated navigation + overlay flows translated into `quickstart.md` manual walkthrough scenarios (with optional extension for automation).
4. Agent context updated via `.specify/scripts/bash/update-agent-context.sh codex`.

**Output**: `data-model.md`, `contracts/README.md`, `quickstart.md`, updated `AGENTS.md`

## Phase 2: Task Planning Approach

**Task Generation Strategy**:

- Base tasks on layout/server component updates, client overlay work, logging, and the manual quickstart steps captured in Phase 1 artifacts.
- Include optional automation tasks only if additional coverage is desired.
- Ensure documentation/logging updates accompany any functional change.

**Ordering Strategy**:

- Implement server data wrapper and caching before client shell so props remain typed.
- Wire Clerk/Convex context and logging prior to overlay UI polish.
- Conduct manual verification and linting after core implementation.

**Estimated Output**: ~15-18 numbered tasks (implementation + manual verification) in `tasks.md`.

## Phase 3+: Future Implementation

_These phases are beyond the scope of the /plan command_

**Phase 3**: Task execution (/tasks command creates tasks.md)  
**Phase 4**: Implementation (execute tasks.md following constitutional principles)  
**Phase 5**: Validation (execute quickstart.md, performance validation)

## Complexity Tracking

No deviations required.

## Progress Tracking

_This checklist is updated during execution flow_

**Phase Status**:

- [x] Phase 0: Research complete (/plan command)
- [x] Phase 1: Design complete (/plan command)
- [ ] Phase 2: Task planning complete (/plan command - describe approach only)
- [ ] Phase 3: Tasks generated (/tasks command)
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:

- [x] Initial Constitution Check: PASS
- [x] Post-Design Constitution Check: PASS
- [x] All NEEDS CLARIFICATION resolved
- [x] Complexity deviations documented (none)

---

_Based on Constitution v1.0.0 - See `/memory/constitution.md`_
